@{
    ViewData["Title"] = "Admin Panel - Yönetim Ekranı";
}

<div class="container-fluid">
    <div class="row">

        <!-- SOL MENÜ -->
        <div class="col-md-3 bg-light vh-100 shadow-sm">
            <h4 class="mt-4 text-center text-success">Admin Panel</h4>
            <ul class="list-group list-group-flush mt-4">
                <li class="list-group-item list-group-item-action" onclick="loadComponent('Odalar')">🛏️ Oda Yönetimi</li>
                <li class="list-group-item list-group-item-action" onclick="loadComponent('Personel')">👤 Personel Yönetimi</li>
                <li class="list-group-item list-group-item-action" onclick="loadComponent('EkPaketler')">📦 Ek Paketler</li>
                <li class="list-group-item list-group-item-action" onclick="loadComponent('Faturalar')">🧾 Faturalar</li>
                <li class="list-group-item list-group-item-action" onclick="loadComponent('Raporlar')">📊 Raporlar</li>
            </ul>

            <!-- Çıkış Butonu -->
            <form asp-controller="Auth" asp-action="Cikis" method="post" class="mt-4 text-center">
                @Html.AntiForgeryToken()
                <button type="submit" class="btn btn-outline-danger">Çıkış Yap</button>
            </form>
        </div>

        <!-- SAĞ PANEL -->
        <div class="col-md-9 p-4" id="panelContent">
            <h5 class="text-muted">Hoş geldin Admin</h5>
            <p>Sol menüden bir bölüm seçerek işlem yapmaya başlayabilirsin.</p>
        </div>

    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
                function loadComponent(componentName) {
                    $.ajax({
                        url: `/ViewComponent/${componentName}`,
                        type: 'GET',
                        success: function (html) {
                            $('#panelContent').html(html);
                            if (componentName === 'Personel') {
                                setTimeout(bindPersonelEvents, 100);
                            } else if (componentName === 'Odalar') {
                                setTimeout(bindOdaEvents, 100);
                            }
                        else if (componentName === 'EkPaketler') {
                               setTimeout(bindEkPaketEvents, 100);
                            }
                        },
                        error: function () {
                            $('#panelContent').html("<div class='alert alert-danger'>İçerik yüklenirken hata oluştu.</div>");
                        }
                    });
                }

                function bindPersonelEvents() {
                    try { window.personeller = personeller; } catch { window.personeller = []; }
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    $('#kayitForm').off('submit').on('submit', function (e) {
                        e.preventDefault();
                        const form = new FormData(this);
                        const id = form.get('PersonelId');
                        const url = id && id !== '0' ? '/AdminPanel/PersonelGuncelle' : '/AdminPanel/PersonelKayit';
                        $.ajax({
                            url: url,
                            type: 'POST',
                            headers: { 'RequestVerificationToken': token },
                            data: form,
                            contentType: false,
                            processData: false,
                            success: () => loadComponent('Personel'),
                            error: xhr => alert('Hata: ' + xhr.responseText)
                        });
                    });

                    $('.sil-btn').off('click').on('click', function () {
                        if (!confirm('Silmek istediğinize emin misiniz?')) return;
                        $.post('/AdminPanel/PersonelSil', { id: +$(this).data('id') })
                            .done(() => loadComponent('Personel'))
                            .fail(() => alert('Silme hatası'));
                    });

                    $('.duzenle-btn').off('click').on('click', function () {
                            const p = personeller.find(x => x.PersonelId === +$(this).data('id'));
                            if (!p) return alert('Kayıt bulunamadı!');
                            ['PersonelId','KullaniciId','Ad','Soyad','Email','Telefon','TcKimlik','PasaportNo']
                                .forEach(k => $(`input[name='${k}']`).val(p[k] || ''));
                            $('input[name="YabanciUyrukluMu"]').prop('checked', p.YabanciUyrukluMu);
                            // Şifre alanını temizle ve optional yap!!
                            $('#sifreInput').val('');
                            $('#sifreInput').removeAttr('required');
                            $('#kaydetBtn').text('Güncelle');
                        });
                }

                function bindOdaEvents() {
                    try { window.odalar = odalar; } catch { window.odalar = []; }
                    const token = $('input[name="__RequestVerificationToken"]').val();

                    $('#odaForm').off('submit').on('submit', function (e) {
                        e.preventDefault();
                        const formData = new FormData(this);
                        const id = formData.get('OdaId');
                        const url = id && id !== '0' ? '/AdminPanel/OdaGuncelle' : '/AdminPanel/OdaEkle';
                        $.ajax({
                            url: url,
                            type: 'POST',
                            headers: { 'RequestVerificationToken': token },
                            data: formData,
                            contentType: false,
                            processData: false,
                            success: () => loadComponent('Odalar'),
                            error: xhr => alert('Hata: ' + xhr.responseText)
                        });
                    });

                    $('.oda-sil').off('click').on('click', function () {
                        if (!confirm('Odayı silmek istiyor musunuz?')) return;
                        $.post('/AdminPanel/OdaSil', { id: +$(this).data('id') })
                            .done(() => loadComponent('Odalar'))
                            .fail(() => alert('Silme hatası'));
                    });

                    $('.oda-duzenle').off('click').on('click', function () {
                        const o = odalar.find(o => o.OdaId === +$(this).data('id'));
                        if (!o) return;
                        ['OdaId','OdaNumarasi'].forEach(k => $(`input[name='${k}']`).val(o[k]));
                        $('select[name="OdaTipiId"]').val(o.OdaTipiId);
                        $('select[name="Durum"]').val(o.Durum);
                        $('#odaKaydetBtn').text('Güncelle');
                    });
                }
                 function bindEkPaketEvents() {
                        try { window.ekPaketler = ekPaketler; } catch { window.ekPaketler = []; }
                        const token = $('input[name="__RequestVerificationToken"]').val();

                        // Kaydet / Güncelle
                        $('#ekPaketForm').off('submit').on('submit', function (e) {
                            e.preventDefault();
                            const form = new FormData(this);
                            const id = form.get('EkPaketId');
                            const url = id && id !== '0'
                                ? '/AdminPanel/EkPaketGuncelle'
                                : '/AdminPanel/EkPaketOlustur';

                            $.ajax({
                                url,
                                type: 'POST',
                                headers: { 'RequestVerificationToken': token },
                                data: form,
                                contentType: false,
                                processData: false,
                            })
                            .done(() => loadComponent('EkPaketler'))
                            .fail(xhr => alert('Hata: ' + xhr.responseText));
                        });

                        // Sil
                        $('.paket-sil').off('click').on('click', function () {
                            if (!confirm('Silmek istediğine emin misin?')) return;
                            $.post('/AdminPanel/EkPaketSil', { id: +$(this).data('id') })
                                .done(() => loadComponent('EkPaketler'))
                                .fail(() => alert('Silme hatası'));
                        });

                        // Düzenle
                        $('.paket-duzenle').off('click').on('click', function () {
                            const p = ekPaketler.find(x => x.EkPaketId === +$(this).data('id'));
                            if (!p) return alert('Kayıt bulunamadı!');
                            ['EkPaketId','PaketAdi','PaketAciklama','Fiyat']
                                .forEach(k => $(`input[name="${k}"]`).val(p[k] || ''));
                            $('#paketKaydetBtn').text('Güncelle');
                        });
                    }

                // $(function () { loadComponent('Odalar'); });
    </script>
}


