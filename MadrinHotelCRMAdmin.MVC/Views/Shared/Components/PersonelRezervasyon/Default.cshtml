@using MadrinHotelCRM.DTO
@using MadrinHotelCRM.DTO.DTOModels
@model RezervasyonEkleViewModel

<div class="row">

	<!-- SOL: Rezervasyon Formu -->
	<div class="col-md-6">
		<h4 class="text-success">Yeni Rezervasyon</h4>
		<form id="rezervasyonForm" class="p-3 border rounded shadow-sm bg-white">
			<input type="hidden" name="RezervasyonId" value="0" />
			<div class="mb-2">
				<label class="form-label">Müşteri</label>
				<select name="MusteriId" class="form-control" required>
					<option value="">Seçiniz</option>
					@foreach (var m in Model.MusteriListesi)
					{
						<option value="@m.MusteriId">@m.Ad @m.Soyad</option>
					}
				</select>
			</div>
			<div class="mb-2">
				<label class="form-label">Tarife</label>
				<select name="TarifeId" class="form-control" required>
					<option value="">Seçiniz</option>
					@foreach (var t in Model.TarifeListesi)
					{
						<option value="@t.TarifeId">@t.TarifeAdi - @t.Fiyat ₺</option>
					}
				</select>
			</div>
			<div class="mb-2">
				<label class="form-label">Başlangıç Tarihi</label>
				<input type="date" name="BaslangicTarihi" class="form-control" required />
			</div>
			<div class="mb-2">
				<label class="form-label">Bitiş Tarihi</label>
				<input type="date" name="BitisTarihi" class="form-control" required />
			</div>
			<div class="mb-2">
				<label class="form-label">Yetişkin</label>
				<input type="number" name="YetiskinSayisi" class="form-control" required />
			</div>
			<div class="mb-2">
				<label class="form-label">Çocuk</label>
				<input type="number" name="CocukSayisi" class="form-control" required />
			</div>

			<button type="submit" class="btn btn-success mt-2">Rezervasyon Ekle</button>
		</form>
	</div>


	<!-- SAĞ: Listeleme -->
	<div class="col-md-6">
		<h4 class="text-primary">Rezervasyonlar</h4>
		<table class="table table-striped table-bordered">
			<thead class="table-light">
				<tr>
					<th>Müşteri</th>
					<th>Başlangıç</th>
					<th>Bitiş</th>
					<th>Yetişkin</th>
					<th>Çocuk</th>
					<th>İşlem</th>
				</tr>
			</thead>
			<tbody>
				@foreach (var r in Model.RezervasyonListesi)
				{
					<tr>
						<td>@r.Musteri</td>
						<td>@r.BaslangicTarihi.ToShortDateString()</td>
						<td>@r.BitisTarihi.ToShortDateString()</td>
						<td>@r.YetiskinSayisi</td>
						<td>@r.CocukSayisi</td>
						<td>
							<button class="btn btn-warning btn-sm rez-duzenle" data-id="@r.RezervasyonId">Düzenle</button>
							<button class="btn btn-danger btn-sm rez-iptal" data-id="@r.RezervasyonId">İptal</button>
						</td>
					</tr>
				}
			</tbody>
		</table>
	</div>

</div>

@section Scripts {
	<script>
		$(document).ready(function () {
			$("#rezervasyonForm").submit(function (e) {
				e.preventDefault();

				var formData = {
					OdaId: $("select[name='OdaId']").val(),
					MusteriId: $("select[name='MusteriId']").val(),
					TarifeId: $("select[name='TarifeId']").val(),
					BaslangicTarihi: $("input[name='BaslangicTarihi']").val(),
					BitisTarihi: $("input[name='BitisTarihi']").val(),
					YetiskinSayisi: $("input[name='YetiskinSayisi']").val(),
					CocukSayisi: $("input[name='CocukSayisi']").val()
				};

					   $.ajax({
						type: "POST",
						url: "https://localhost:7225/api/rezervasyon", // senin port numarana göre
						data: JSON.stringify(formData),
						contentType: "application/json",
						success: function (msg) {
						alert("✔️ Rezervasyon başarıyla eklendi!");
						location.reload();
			},
						error: function (xhr) {
						alert("❌ Hata oluştu: " + xhr.responseText);
			}
				});

			});
		});

		var rezervasyonlar = @Html.Raw(Json.Serialize(Model.RezervasyonListesi));

		// DÜZENLE
		$(document).on("click", ".rez-duzenle", function () {
			const id = $(this).data("id");
			const rez = rezervasyonlar.find(r => r.RezervasyonId === id);
			if (!rez) return;

			$("input[name='RezervasyonId']").val(rez.RezervasyonId); // gizli input ekle form içine
			$("select[name='MusteriId']").val(rez.MusteriId);
			$("select[name='TarifeId']").val(rez.TarifeId);
			$("input[name='BaslangicTarihi']").val(rez.BaslangicTarihi.split("T")[0]);
			$("input[name='BitisTarihi']").val(rez.BitisTarihi.split("T")[0]);
			$("input[name='YetiskinSayisi']").val(rez.YetiskinSayisi);
			$("input[name='CocukSayisi']").val(rez.CocukSayisi);
		});

		// İPTAL
		$(document).on("click", ".rez-iptal", function () {
			const id = $(this).data("id");
			if (!confirm("Bu rezervasyonu iptal etmek istediğine emin misin?")) return;

			$.ajax({
				type: "PUT",
				url: `/PersonelPanel/RezervasyonIptal/${id}`,
				success: () => location.reload(),
				error: (xhr) => alert("İptal başarısız: " + xhr.responseText)
			});
		});

	</script>


}

